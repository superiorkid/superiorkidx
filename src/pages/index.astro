---
import AboutSection from "@/components/AboutSection.astro";
import BlogSection from "@/components/BlogSection.astro";
import ProjectSection from "@/components/ProjectSection.astro";
import WorkExperience from "@/components/WorkExperience.astro";
import type { ExperienceSkeleton } from "@/interfaces/experience.interface";
import type {
  Availability,
  ProfileSkeleton,
} from "@/interfaces/profile.interface";
import type { ProjectSkeleton } from "@/interfaces/project.interface";
import type { SkillSkeleton } from "@/interfaces/skill.interface";
import MainLayout from "@/layouts/MainLayout.astro";
import { contentfulClient } from "@/lib/contentful";
import { documentToHtmlString } from "@contentful/rich-text-html-renderer";
import { marked } from "marked";

const [profileEntries, skillsEntries, experienceEntries, projectEntries] =
  await Promise.all([
    contentfulClient.getEntries<ProfileSkeleton>({
      content_type: "profile",
      limit: 1,
    }),
    contentfulClient.getEntries<SkillSkeleton>({
      content_type: "skills",
    }),
    contentfulClient.getEntries<ExperienceSkeleton>({
      content_type: "experience",
      order: ["-fields.startDate"],
    }),
    contentfulClient.getEntries<ProjectSkeleton>({
      content_type: "project",
      limit: 3,
      order: ["-fields.startDate"],
    }),
  ]);

const profile = profileEntries.items.at(0)?.fields;
const { summary, about } = profile || {};
const availability = profile?.availability as unknown as Availability;

const skills = skillsEntries.items.map((skill) => skill.fields);
const experiences = experienceEntries.items.map(
  (experience) => experience.fields
);
const projects = projectEntries.items
  .map((projectField) => projectField.fields)
  .map((project) => ({
    ...project,
    description: marked(project.description as unknown as string) as string,
  }));
---

<MainLayout>
  <AboutSection
    avatar={profile?.avatar as string}
    name={profile?.name as string}
    role={profile?.role as string}
    isAvailable={availability.status === "available"}
    email={profile?.email as string}
    skills={skills}
    summary={documentToHtmlString(summary!)}
    about={documentToHtmlString(about!)}
  />
  <ProductSection />
  {experiences && <WorkExperience experiences={experiences} />}
  {projects && <ProjectSection projects={projects} showMoreButton />}
  <BlogSection />
</MainLayout>
